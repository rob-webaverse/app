version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: latest
  pre_build:  
    commands:
      - echo Downloading source...
      - git clone --recurse-submodules https://github.com/rob-webaverse/app.git
      - cd ./app
      - echo Entered the install phase...
      - sudo apt update -y
      - sudo npm install -y
      - echo Install apt-transport-https
      - sudo apt-get install -y apt-transport-https
      - echo Use apt to install the Chrome dependencies
      - sudo apt-get install xvfb
      - sudo apt-get install -y libxcursor1
      - sudo apt-get install -y libgtk-3-dev
      - sudo apt-get install -y libxss1
      - sudo apt-get install -y libasound2
      - sudo apt-get install -y libnspr4
      - sudo apt-get install -y libnss3
      - sudo apt-get install -y libx11-xcb1
  test_runs:
    commands:
      - npm run setup:test
      - npm run start
      - cd test
      - npm run test
  post_build:
    commands:
      - echo Tests completed on `date`
      - echo Writing image definitions file...
      - printf '[{"name":"ECSContainer-app-'$AWS_DEFAULT_REGION'","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
artifacts:
    files: imagedefinitions.json
